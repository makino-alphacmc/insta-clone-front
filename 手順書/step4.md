# Step 4: Backend ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆFastAPI + SQLite + SQLAlchemyï¼‰

## ðŸ“‹ ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚„ã‚‹ã“ã¨

Instagram ã‚¯ãƒ­ãƒ¼ãƒ³ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
- FastAPI ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
- SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®š
- SQLAlchemy ã®è¨­å®š
- åŸºæœ¬çš„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…

## âœ… æ‰‹é †

### 4-1) ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
â€» ç›®çš„: APIç”¨ã®ç‹¬ç«‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ‡ã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã¨ç–Žçµåˆã«ã™ã‚‹åœŸå°ã‚’ä½œã‚‹ï¼ˆå› æžœ: å¾Œã®Dockeråˆ†é›¢ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®¹æ˜“ã«ãªã‚‹ï¼‰ã€‚

```bash
# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd ~/work

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir insta-clone-api
cd insta-clone-api
```

### 4-2) ä»®æƒ³ç’°å¢ƒã®ä½œæˆï¼ˆæŽ¨å¥¨ï¼‰
â€» ç›®çš„: ä¾å­˜è¡çªã‚’é¿ã‘ã€ç’°å¢ƒã‚’å†ç¾å¯èƒ½ã«ã™ã‚‹ã€‚

```bash
# ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆ
python3 -m venv venv

# ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–
source venv/bin/activate  # macOS/Linux
# Windows ã®å ´åˆã¯: venv\Scripts\activate
```

### 4-3) ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
â€» ç›®çš„: FastAPI + SQLAlchemy ã‚’æœ€å°æ§‹æˆã§å‹•ã‹ã™åŸºç›¤ã‚’ç”¨æ„ã€‚

```bash
# FastAPI ã¨ãã®ä¾å­˜é–¢ä¿‚
pip install fastapi uvicorn[standard] python-dotenv

# SQLAlchemyï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ORMï¼‰
pip install sqlalchemy
```

### 4-4) ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã®ä½œæˆ
â€» ç›®çš„: appé…ä¸‹ã«è²¬å‹™ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã€ä¿å®ˆæ€§ã‚’ç¢ºä¿ã€‚

```bash
# app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
mkdir -p app
touch app/__init__.py
touch app/main.py
touch app/db.py
touch app/models.py
touch app/schemas.py
touch app/storage.py
```

### 4-5) ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šï¼ˆapp/db.pyï¼‰
â€» ç›®çš„: DBæŽ¥ç¶šã¨Sessionç®¡ç†ã‚’ä¸€å…ƒåŒ–ã—ã€å„APIã§å†åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

`app/db.py` ã‚’ç·¨é›†ã—ã¾ã™ï¼š

```python
# 
# ã€æ„å‘³ã€‘SQLAlchemy ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã«å¿…è¦ãªæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€
# ã€å› æžœã€‘create_engine ã§ DB æŽ¥ç¶šã€sessionmaker ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€declarative_base ã§ãƒ¢ãƒ‡ãƒ«å®šç¾©
# ã€å­¦ã³ã€‘SQLAlchemy ã¯ Python ã® ORMï¼ˆObject-Relational Mappingï¼‰ã§ã€SQL ã‚’ç›´æŽ¥æ›¸ã‹ãšã« DB ã‚’æ“ä½œã§ãã‚‹
#
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# 
# ã€æ„å‘³ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šURL: SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’æŒ‡å®š
# ã€å› æžœã€‘"sqlite:///./app.db" ã§ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« app.db ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
# ã€å­¦ã³ã€‘SQLite ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã€ã‚µãƒ¼ãƒãƒ¼ä¸è¦ã§å‹•ä½œã™ã‚‹ï¼ˆé–‹ç™ºã«æœ€é©ï¼‰
# ã€å­¦ã³ã€‘æœ¬ç•ªç’°å¢ƒã§ã¯ PostgreSQL ã‚„ MySQL ãªã©ã®ã‚µãƒ¼ãƒãƒ¼åž‹ DB ã‚’ä½¿ã†ã“ã¨ãŒå¤šã„
#
SQLALCHEMY_DATABASE_URL = "sqlite:///./app.db"

# 
# ã€æ„å‘³ã€‘ã‚¨ãƒ³ã‚¸ãƒ³ã®ä½œæˆ: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŽ¥ç¶šã‚’ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
# ã€å› æžœã€‘create_engine ã§æŽ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆã—ã€è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§åŠ¹çŽ‡çš„ã«æŽ¥ç¶šã‚’å†åˆ©ç”¨
# ã€å­¦ã³ã€‘connect_args={"check_same_thread": False} ã¯ SQLite å°‚ç”¨ã®è¨­å®š
#   - SQLite ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒžãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è¨±å¯ã—ãªã„ãŒã€FastAPI ã¯éžåŒæœŸã§å‹•ä½œã™ã‚‹ãŸã‚å¿…è¦
#
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, 
    connect_args={"check_same_thread": False}  # SQLiteç”¨ã®è¨­å®š
)

# 
# ã€æ„å‘³ã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ã®ä½œæˆ: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã‚’ä½œæˆ
# ã€å› æžœã€‘SessionLocal ã‚’å‘¼ã³å‡ºã™ã¨ã€æ–°ã—ã„ DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹
# ã€å­¦ã³ã€‘autocommit=False: è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆæ˜Žç¤ºçš„ã« commit() ã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹ï¼‰
# ã€å­¦ã³ã€‘autoflush=False: è‡ªå‹•ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚ã«è‡ªå‹•ä¿å­˜ã—ãªã„ï¼‰
# ã€å­¦ã³ã€‘bind=engine: ã©ã®ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ã†ã‹ã‚’æŒ‡å®š
#
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# 
# ã€æ„å‘³ã€‘Base ã‚¯ãƒ©ã‚¹: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹
# ã€å› æžœã€‘declarative_base() ã§ä½œæˆã—ãŸ Base ã‚’ç¶™æ‰¿ã™ã‚‹ã“ã¨ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ãŒç°¡å˜ã«ãªã‚‹
# ã€å­¦ã³ã€‘models.py ã§ Post(Base) ã®ã‚ˆã†ã«ç¶™æ‰¿ã—ã¦ä½¿ã†
#
Base = declarative_base()
```

### 4-6) ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼ˆapp/models.pyï¼‰
â€» ç›®çš„: postsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ ã‚’ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã—ã€ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸºç›¤ã«å‚™ãˆã‚‹ã€‚

`app/models.py` ã‚’ç·¨é›†ã—ã¾ã™ï¼š

```python
# 
# ã€æ„å‘³ã€‘å¿…è¦ãªã‚¯ãƒ©ã‚¹ã¨é–¢æ•°ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# ã€å› æžœã€‘Column ã§ã‚«ãƒ©ãƒ å®šç¾©ã€Integer/String/DateTime ã§ãƒ‡ãƒ¼ã‚¿åž‹ã€func ã§ SQL é–¢æ•°ã‚’ä½¿ç”¨
#
from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.sql import func
from app.db import Base

# 
# ã€æ„å‘³ã€‘Post ãƒ¢ãƒ‡ãƒ«: æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ã™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©
# ã€å› æžœã€‘Base ã‚’ç¶™æ‰¿ã™ã‚‹ã“ã¨ã§ã€SQLAlchemy ãŒè‡ªå‹•çš„ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆãƒ»ç®¡ç†ã—ã¦ãã‚Œã‚‹
# ã€å­¦ã³ã€‘ORM ã‚’ä½¿ã†ã“ã¨ã§ã€Python ã®ã‚¯ãƒ©ã‚¹ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ“ä½œã§ãã‚‹
#
class Post(Base):
    # 
    # ã€æ„å‘³ã€‘ãƒ†ãƒ¼ãƒ–ãƒ«åã®æŒ‡å®š: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½œæˆã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«å
    # ã€å› æžœã€‘__tablename__ ãŒãªã„å ´åˆã€ã‚¯ãƒ©ã‚¹åï¼ˆPostï¼‰ãŒå°æ–‡å­—ã«ãªã£ã¦ãƒ†ãƒ¼ãƒ–ãƒ«åã«ãªã‚‹
    #
    __tablename__ = "posts"

    # 
    # ã€æ„å‘³ã€‘id ã‚«ãƒ©ãƒ : æŠ•ç¨¿ã®ä¸€æ„ã®è­˜åˆ¥å­ï¼ˆä¸»ã‚­ãƒ¼ï¼‰
    # ã€å› æžœã€‘primary_key=True ã§ä¸»ã‚­ãƒ¼ã«è¨­å®šã€index=True ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼ˆæ¤œç´¢ãŒé«˜é€ŸåŒ–ï¼‰
    # ã€å­¦ã³ã€‘Integer åž‹ã§æ•´æ•°ã‚’ä¿å­˜
    #
    id = Column(Integer, primary_key=True, index=True)
    
    # 
    # ã€æ„å‘³ã€‘image_url ã‚«ãƒ©ãƒ : ç”»åƒã® URL ã‚’ä¿å­˜
    # ã€å› æžœã€‘nullable=False ã§ NULL å€¤ã‚’è¨±å¯ã—ãªã„ï¼ˆå¿…é ˆé …ç›®ï¼‰
    # ã€å­¦ã³ã€‘String åž‹ã§æ–‡å­—åˆ—ã‚’ä¿å­˜ï¼ˆé•·ã•åˆ¶é™ãªã—ï¼‰
    #
    image_url = Column(String, nullable=False)
    
    # 
    # ã€æ„å‘³ã€‘caption ã‚«ãƒ©ãƒ : æŠ•ç¨¿ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆèª¬æ˜Žæ–‡ï¼‰ã‚’ä¿å­˜
    # ã€å› æžœã€‘nullable=True ã§ NULL å€¤ã‚’è¨±å¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ï¼‰
    # ã€å­¦ã³ã€‘ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¯ç©ºã§ã‚‚æŠ•ç¨¿ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    #
    caption = Column(String, nullable=True)
    
    # 
    # ã€æ„å‘³ã€‘created_at ã‚«ãƒ©ãƒ : æŠ•ç¨¿ã®ä½œæˆæ—¥æ™‚ã‚’ä¿å­˜
    # ã€å› æžœã€‘DateTime(timezone=True) ã§ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’å«ã‚€æ—¥æ™‚åž‹
    # ã€å­¦ã³ã€‘server_default=func.now() ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§è‡ªå‹•çš„ã«ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š
    # ã€å­¦ã³ã€‘Python å´ã§å€¤ã‚’æŒ‡å®šã—ãªãã¦ã‚‚ã€DB ãŒè‡ªå‹•çš„ã«ç¾åœ¨æ™‚åˆ»ã‚’å…¥ã‚Œã¦ãã‚Œã‚‹
    #
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

### 4-7) ã‚¹ã‚­ãƒ¼ãƒžå®šç¾©ï¼ˆapp/schemas.pyï¼‰
â€» ç›®çš„: å…¥å‡ºåŠ›ã®åž‹ã‚’æ˜Žç¤ºã—ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨è‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã‚’è¡Œã†ã€‚

`app/schemas.py` ã‚’ç·¨é›†ã—ã¾ã™ï¼š

```python
# 
# ã€æ„å‘³ã€‘Pydantic ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
# ã€å› æžœã€‘FastAPI ã¯ Pydantic ã‚’ä½¿ã£ã¦ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®åž‹ãƒã‚§ãƒƒã‚¯ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†
# ã€å­¦ã³ã€‘BaseModel ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã¯ã€è‡ªå‹•çš„ã« JSON ã¨ã®å¤‰æ›ãŒå¯èƒ½ã«ãªã‚‹
#
from pydantic import BaseModel
from datetime import datetime

# 
# ã€æ„å‘³ã€‘PostBase: æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬ã‚¹ã‚­ãƒ¼ãƒžï¼ˆå…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®šç¾©ï¼‰
# ã€å› æžœã€‘ç¶™æ‰¿ã‚’ä½¿ã£ã¦ã€é‡è¤‡ã‚’é¿ã‘ãªãŒã‚‰è¤‡æ•°ã®ã‚¹ã‚­ãƒ¼ãƒžã‚’å®šç¾©ã§ãã‚‹
# ã€å­¦ã³ã€‘image_url ã¯å¿…é ˆï¼ˆstr åž‹ï¼‰ã€caption ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆstr | None = Noneï¼‰
# ã€å­¦ã³ã€‘str | None ã¯ Python 3.10+ ã®è¨˜æ³•ã§ã€str ã¾ãŸã¯ None ã‚’æ„å‘³ã™ã‚‹
#
class PostBase(BaseModel):
    image_url: str  # ã€æ„å‘³ã€‘ç”»åƒURLï¼ˆå¿…é ˆé …ç›®ï¼‰
    caption: str | None = None  # ã€æ„å‘³ã€‘ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ Noneï¼‰

# 
# ã€æ„å‘³ã€‘PostCreate: æ–°è¦æŠ•ç¨¿ä½œæˆæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚­ãƒ¼ãƒž
# ã€å› æžœã€‘PostBase ã‚’ç¶™æ‰¿ã—ã€id ã‚„ created_at ã¯å«ã¾ãªã„ï¼ˆã“ã‚Œã‚‰ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ï¼‰
# ã€å­¦ã³ã€‘API ã® POST /posts ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ä½¿ç”¨ã•ã‚Œã‚‹
#
class PostCreate(PostBase):
    pass  # ã€æ„å‘³ã€‘PostBase ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆè¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—ï¼‰

# 
# ã€æ„å‘³ã€‘Post: æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒžï¼ˆå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€ï¼‰
# ã€å› æžœã€‘PostBase ã«åŠ ãˆã¦ã€id ã¨ created_at ã‚’å«ã‚€ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸå®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ï¼‰
# ã€å­¦ã³ã€‘API ã® GET /posts ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ä½¿ç”¨ã•ã‚Œã‚‹
#
class Post(PostBase):
    id: int  # ã€æ„å‘³ã€‘æŠ•ç¨¿IDï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§è‡ªå‹•ç”Ÿæˆï¼‰
    created_at: datetime  # ã€æ„å‘³ã€‘ä½œæˆæ—¥æ™‚ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§è‡ªå‹•è¨­å®šï¼‰

    # 
    # ã€æ„å‘³ã€‘Config ã‚¯ãƒ©ã‚¹: Pydantic ã®è¨­å®šã‚’å®šç¾©
    # ã€å› æžœã€‘from_attributes = True ã§ã€SQLAlchemy ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰è‡ªå‹•çš„ã« Pydantic ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›å¯èƒ½
    # ã€å­¦ã³ã€‘ã“ã‚Œã«ã‚ˆã‚Šã€db.query(Post).all() ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã€ãã®ã¾ã¾ Post ã‚¹ã‚­ãƒ¼ãƒžã¨ã—ã¦è¿”ã›ã‚‹
    #
    class Config:
        from_attributes = True  # æ—§å: orm_mode = Trueï¼ˆPydantic v2 ã§ã¯ from_attributesï¼‰
```

### 4-8) ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆapp/main.pyï¼‰
â€» ç›®çš„: CORSã‚„ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å«ã‚€æœ€å°APIã‚’æ§‹ç¯‰ã—ã€å‹•ä½œç¢ºèªã®åŸºæº–ç‚¹ã‚’ä½œã‚‹ã€‚

`app/main.py` ã‚’ç·¨é›†ã—ã¾ã™ï¼š

```python
# 
# ã€æ„å‘³ã€‘FastAPI ã¨é–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# ã€å› æžœã€‘FastAPI ã§ API ã‚’ä½œæˆã€Depends ã§ä¾å­˜æ€§æ³¨å…¥ã€CORSMiddleware ã§ CORS è¨­å®š
# ã€å­¦ã³ã€‘HTTPException ã§ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€Session ã§ DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€List ã§åž‹ãƒ’ãƒ³ãƒˆ
#
from fastapi import FastAPI, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy.orm import Session
from typing import List
import os
from dotenv import load_dotenv

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from app import models, schemas
from app.db import SessionLocal, engine

# 
# ã€æ„å‘³ã€‘ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿: .env ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
# ã€å› æžœã€‘load_dotenv() ã§ .env ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ os.getenv() ã§å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
# ã€å­¦ã³ã€‘æ©Ÿå¯†æƒ…å ±ï¼ˆAPI ã‚­ãƒ¼ãªã©ï¼‰ã‚’ã‚³ãƒ¼ãƒ‰ã«ç›´æŽ¥æ›¸ã‹ãšã€ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã§ãã‚‹
#
load_dotenv()

# 
# ã€æ„å‘³ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®è‡ªå‹•ä½œæˆ: ãƒ¢ãƒ‡ãƒ«å®šç¾©ã«åŸºã¥ã„ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
# ã€å› æžœã€‘create_all() ã§ models.py ã§å®šç¾©ã—ãŸã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã‚‹
# ã€å­¦ã³ã€‘æœ¬ç•ªç’°å¢ƒã§ã¯ Alembic ãªã©ã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã“ã¨ãŒæŽ¨å¥¨ã•ã‚Œã‚‹
# ã€å­¦ã³ã€‘bind=engine ã§ã©ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ã†ã‹ã‚’æŒ‡å®š
#
models.Base.metadata.create_all(bind=engine)

# 
# ã€æ„å‘³ã€‘FastAPI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
# ã€å› æžœã€‘app ãŒ API ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã„ã
# ã€å­¦ã³ã€‘FastAPI ã¯è‡ªå‹•çš„ã« OpenAPI ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆSwagger UIï¼‰ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹
#
app = FastAPI()

# 
# ã€æ„å‘³ã€‘CORSï¼ˆCross-Origin Resource Sharingï¼‰è¨­å®š: ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã‚’ç·©å’Œ
# ã€å› æžœã€‘ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆlocalhost:3000ï¼‰ã‹ã‚‰ APIï¼ˆlocalhost:8000ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«å¿…è¦
# ã€å­¦ã³ã€‘ç•°ãªã‚‹ã‚ªãƒªã‚¸ãƒ³ï¼ˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒãƒ¼ãƒˆï¼‰é–“ã§ã®é€šä¿¡ã‚’è¨±å¯ã™ã‚‹
# ã€å­¦ã³ã€‘allowed_origins ã§è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã‚’æŒ‡å®šï¼ˆè¤‡æ•°æŒ‡å®šå¯èƒ½ã€ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šï¼‰
#
allowed_origins = os.getenv("ALLOWED_ORIGINS", "http://localhost:3000").split(",")
app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,  # ã€æ„å‘³ã€‘è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã®ãƒªã‚¹ãƒˆ
    allow_credentials=True,  # ã€æ„å‘³ã€‘ã‚¯ãƒƒã‚­ãƒ¼ãªã©ã®èªè¨¼æƒ…å ±ã‚’è¨±å¯
    allow_methods=["*"],  # ã€æ„å‘³ã€‘ã™ã¹ã¦ã® HTTP ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆGET, POST ãªã©ï¼‰ã‚’è¨±å¯
    allow_headers=["*"],  # ã€æ„å‘³ã€‘ã™ã¹ã¦ã® HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨±å¯
)

# 
# ã€æ„å‘³ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¾å­˜é–¢ä¿‚: å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
# ã€å› æžœã€‘Depends(get_db) ã‚’ä½¿ã†ã“ã¨ã§ã€FastAPI ãŒè‡ªå‹•çš„ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¦ãã‚Œã‚‹
# ã€å­¦ã³ã€‘yield ã‚’ä½¿ã†ã“ã¨ã§ã€é–¢æ•°ã®å®Ÿè¡Œå¾Œï¼ˆfinally ãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã«ç¢ºå®Ÿã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‰ã‚Œã‚‹
# ã€å­¦ã³ã€‘ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚„æŽ¥ç¶šã®æž¯æ¸‡ã‚’é˜²ã
#
def get_db():
    db = SessionLocal()  # ã€æ„å‘³ã€‘æ–°ã—ã„ DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    try:
        yield db  # ã€æ„å‘³ã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã—å…ƒã«æ¸¡ã™ï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè¡Œä¸­ã¯æœ‰åŠ¹ï¼‰
    finally:
        db.close()  # ã€æ„å‘³ã€‘ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‡¦ç†ãŒçµ‚ã‚ã£ãŸã‚‰ã€å¿…ãšã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹

# 
# ã€æ„å‘³ã€‘ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: API ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
# ã€å› æžœã€‘ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã‚„ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ã€API ã®ç¨¼åƒçŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨
# ã€å­¦ã³ã€‘GET /health ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ {"status": "ok"} ãŒè¿”ã‚Œã°ã€API ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹
#
@app.get("/health")
def health_check():
    return {"status": "ok"}

# 
# ã€æ„å‘³ã€‘æŠ•ç¨¿ä¸€è¦§å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’å–å¾—ã™ã‚‹
# ã€å› æžœã€‘GET /posts ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æŠ•ç¨¿ä¸€è¦§ã‚’å–å¾—ã—ã¦è¿”ã™
# ã€å­¦ã³ã€‘response_model=List[schemas.Post] ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®åž‹ã‚’æŒ‡å®šï¼ˆè‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«ä½¿ç”¨ï¼‰
# ã€å­¦ã³ã€‘skip ã¨ limit ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†å‰²ã—ã¦å–å¾—ï¼‰ã«å¯¾å¿œ
#
# ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œï¼ˆGET /posts ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼‰ã€‘:
#   1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: fetch('http://localhost:8000/posts') ã‚’é€ä¿¡
#   2. FastAPI: GET /posts ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‘¼ã°ã‚Œã‚‹
#   3. get_db(): DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ â†’ db å¤‰æ•°ã«æ¸¡ã•ã‚Œã‚‹
#   4. db.query(models.Post): SQLAlchemy ãŒ SQL ã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆ
#      â†’ SELECT * FROM posts ORDER BY created_at DESC LIMIT 100 OFFSET 0
#   5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: SQL ã‚’å®Ÿè¡Œ â†’ æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
#   6. .all(): SQLAlchemy ãŒçµæžœã‚’ Post ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆã«å¤‰æ›
#      â†’ [Post(id=1, image_url="...", ...), Post(id=2, ...), ...]
#   7. return posts: FastAPI ãŒ Pydantic ã‚¹ã‚­ãƒ¼ãƒžï¼ˆschemas.Postï¼‰ã«å¤‰æ›
#      â†’ [{"id": 1, "image_url": "...", ...}, {"id": 2, ...}, ...]
#   8. FastAPI: JSON å½¢å¼ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º â†’ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã™
#   9. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: JSON ã‚’å—ä¿¡ â†’ JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ› â†’ ç”»é¢ã«è¡¨ç¤º
#
@app.get("/posts", response_model=List[schemas.Post])
def get_posts(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    # 
    # ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã€‘db (Session ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
    #   â†“ .query(models.Post) â†’ SQLAlchemy ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼
    #   â†“ .order_by(...) â†’ ORDER BY created_at DESC ã‚’è¿½åŠ 
    #   â†“ .offset(skip) â†’ OFFSET 0 ã‚’è¿½åŠ ï¼ˆã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ä»¶æ•°ï¼‰
    #   â†“ .limit(limit) â†’ LIMIT 100 ã‚’è¿½åŠ ï¼ˆå–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°ï¼‰
    #   â†“ .all() â†’ SQL ã‚’å®Ÿè¡Œã—ã¦çµæžœã‚’å–å¾—
    #   â†“ posts = [Post ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ, Post ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ, ...]
    # ã€æ„å‘³ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒª: æŠ•ç¨¿ã‚’å–å¾—ã—ã¦ã€ä½œæˆæ—¥æ™‚ã®é™é †ï¼ˆæ–°ã—ã„é †ï¼‰ã§ã‚½ãƒ¼ãƒˆ
    # ã€å› æžœã€‘order_by(models.Post.created_at.desc()) ã§æ–°ã—ã„æŠ•ç¨¿ã‹ã‚‰é †ã«ä¸¦ã¹ã‚‹
    # ã€å­¦ã³ã€‘offset(skip) ã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ä»¶æ•°ã€limit(limit) ã§å–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°ã‚’æŒ‡å®š
    # ã€å­¦ã³ã€‘.all() ã§ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€çµæžœã‚’ãƒªã‚¹ãƒˆã¨ã—ã¦å–å¾—
    #
    posts = db.query(models.Post).order_by(models.Post.created_at.desc()).offset(skip).limit(limit).all()
    
    # ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã€‘posts = [Post ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ, ...]
    #   â†“ FastAPI ãŒ response_model=List[schemas.Post] ã«åŸºã¥ã„ã¦å¤‰æ›
    #   â†“ [{"id": 1, "image_url": "...", ...}, ...] (Pydantic ãƒ¢ãƒ‡ãƒ«)
    #   â†“ JSON ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
    #   â†“ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£: [{"id": 1, "image_url": "...", ...}, ...]
    #   â†“ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«é€ä¿¡
    return posts  # ã€æ„å‘³ã€‘å–å¾—ã—ãŸæŠ•ç¨¿ãƒªã‚¹ãƒˆã‚’ JSON å½¢å¼ã§è¿”ã™ï¼ˆFastAPI ãŒè‡ªå‹•å¤‰æ›ï¼‰

# 
# ã€æ„å‘³ã€‘æŠ•ç¨¿ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: æ–°ã—ã„æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹
# ã€å› æžœã€‘POST /posts ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ–°ã—ã„æŠ•ç¨¿ãŒä¿å­˜ã•ã‚Œã‚‹
# ã€æ³¨æ„ã€‘ç¾åœ¨ã¯ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯æœªå®Ÿè£…ï¼ˆStep 5 ã§å®Ÿè£…ï¼‰
#
# ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œï¼ˆPOST /posts ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼‰ã€‘:
#   1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: FormData { file: File, caption: "..." } ã‚’é€ä¿¡
#   2. FastAPI: POST /posts ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‘¼ã°ã‚Œã‚‹
#   3. FastAPI: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ Pydantic ã‚¹ã‚­ãƒ¼ãƒžï¼ˆschemas.PostCreateï¼‰ã«å¤‰æ›
#      â†’ post = PostCreate(image_url="...", caption="...")
#   4. get_db(): DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ â†’ db å¤‰æ•°ã«æ¸¡ã•ã‚Œã‚‹
#   5. post.dict(): Pydantic ãƒ¢ãƒ‡ãƒ«ã‚’è¾žæ›¸ã«å¤‰æ› â†’ {"image_url": "...", "caption": "..."}
#   6. models.Post(**post.dict()): è¾žæ›¸ã‚’å±•é–‹ã—ã¦ Post ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
#      â†’ db_post = Post(image_url="...", caption="...", id=None, created_at=None)
#   7. db.add(db_post): ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ ï¼ˆã¾ã  DB ã«ã¯ä¿å­˜ã•ã‚Œã¦ã„ãªã„ï¼‰
#   8. db.commit(): SQL ã‚’å®Ÿè¡Œã—ã¦ DB ã«ä¿å­˜
#      â†’ INSERT INTO posts (image_url, caption, created_at) VALUES (..., ..., NOW())
#      â†’ DB ãŒè‡ªå‹•çš„ã« id ã¨ created_at ã‚’ç”Ÿæˆ
#   9. db.refresh(db_post): DB ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
#      â†’ db_post.id = 1, db_post.created_at = "2024-01-01T12:00:00"
#   10. return db_post: FastAPI ãŒ Pydantic ã‚¹ã‚­ãƒ¼ãƒžï¼ˆschemas.Postï¼‰ã«å¤‰æ›
#       â†’ {"id": 1, "image_url": "...", "caption": "...", "created_at": "..."}
#   11. FastAPI: JSON å½¢å¼ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º â†’ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã™
#   12. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: JSON ã‚’å—ä¿¡ â†’ æˆåŠŸã‚’é€šçŸ¥ â†’ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«é·ç§»
#
@app.post("/posts", response_model=schemas.Post)
def create_post(post: schemas.PostCreate, db: Session = Depends(get_db)):
    # 
    # ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã€‘post = PostCreate(image_url="...", caption="...")
    #   â†“ .dict() â†’ {"image_url": "...", "caption": "..."}
    #   â†“ ** ã§å±•é–‹ â†’ image_url="...", caption="..."
    #   â†“ models.Post(image_url="...", caption="...")
    #   â†“ db_post = Post(id=None, image_url="...", caption="...", created_at=None)
    # ã€æ„å‘³ã€‘Pydantic ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ SQLAlchemy ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›
    # ã€å› æžœã€‘post.dict() ã§è¾žæ›¸ã«å¤‰æ›ã—ã€** ã§å±•é–‹ã—ã¦ Post ãƒ¢ãƒ‡ãƒ«ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«æ¸¡ã™
    # ã€å­¦ã³ã€‘**post.dict() ã¯ image_url ã¨ caption ã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•æ•°ã¨ã—ã¦å±•é–‹ã™ã‚‹
    #
    db_post = models.Post(**post.dict())
    
    # 
    # ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã€‘db_post (Post ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
    #   â†“ db.add(db_post) â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã€Œè¿½åŠ äºˆå®šãƒªã‚¹ãƒˆã€ã«è¿½åŠ 
    #   â†“ ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã  DB ã«ã¯ä¿å­˜ã•ã‚Œã¦ã„ãªã„ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ï¼‰
    # ã€æ„å‘³ã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ : æ–°ã—ã„æŠ•ç¨¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ ï¼ˆã¾ã  DB ã«ã¯ä¿å­˜ã•ã‚Œãªã„ï¼‰
    # ã€å› æžœã€‘db.add() ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ ã—ã€db.commit() ã§å®Ÿéš›ã« DB ã«ä¿å­˜
    #
    db.add(db_post)
    
    # 
    # ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã€Œè¿½åŠ äºˆå®šãƒªã‚¹ãƒˆã€
    #   â†“ db.commit() â†’ SQL ã‚’ç”Ÿæˆã—ã¦å®Ÿè¡Œ
    #   â†“ INSERT INTO posts (image_url, caption, created_at) VALUES (..., ..., NOW())
    #   â†“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå®Ÿè¡Œ â†’ ãƒ‡ãƒ¼ã‚¿ãŒæ°¸ç¶šåŒ–ã•ã‚Œã‚‹
    #   â†“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè‡ªå‹•çš„ã« id ã¨ created_at ã‚’ç”Ÿæˆ
    # ã€æ„å‘³ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚³ãƒŸãƒƒãƒˆ: å¤‰æ›´ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ°¸ç¶šåŒ–
    # ã€å› æžœã€‘commit() ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºå®šã—ã€ãƒ‡ãƒ¼ã‚¿ãŒå®Ÿéš›ã«ä¿å­˜ã•ã‚Œã‚‹
    # ã€å­¦ã³ã€‘ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã‚‹
    #
    db.commit()
    
    # 
    # ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã€‘db_post (id=None, created_at=None ã®ã¾ã¾)
    #   â†“ db.refresh(db_post) â†’ SELECT * FROM posts WHERE id = ? ã‚’å®Ÿè¡Œ
    #   â†“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    #   â†“ db_post.id = 1, db_post.created_at = "2024-01-01T12:00:00"
    # ã€æ„å‘³ã€‘ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    # ã€å› æžœã€‘commit() å¾Œã€id ã‚„ created_at ãªã©ã®è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå€¤ãŒ db_post ã«åæ˜ ã•ã‚Œã‚‹
    # ã€å­¦ã³ã€‘refresh() ã—ãªã„ã¨ã€id ã‚„ created_at ãŒ None ã®ã¾ã¾ã«ãªã‚‹
    #
    db.refresh(db_post)
    
    # ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã€‘db_post = Post(id=1, image_url="...", caption="...", created_at="...")
    #   â†“ FastAPI ãŒ response_model=schemas.Post ã«åŸºã¥ã„ã¦å¤‰æ›
    #   â†“ {"id": 1, "image_url": "...", "caption": "...", "created_at": "..."}
    #   â†“ JSON ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
    #   â†“ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£: {"id": 1, "image_url": "...", ...}
    #   â†“ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«é€ä¿¡
    return db_post  # ã€æ„å‘³ã€‘ä½œæˆã•ã‚ŒãŸæŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’ JSON å½¢å¼ã§è¿”ã™
```

### 4-9) ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.envï¼‰
â€» ç›®çš„: ç’°å¢ƒä¾å­˜å€¤ã‚’ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ†é›¢ã—ã€æœ¬ç•ª/é–‹ç™ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚„ã™ãã™ã‚‹ã€‚

`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ï¼š

```bash
cat > .env << 'EOF'
ALLOWED_ORIGINS=http://localhost:3000
EOF
```

### 4-10) ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã¨å‹•ä½œç¢ºèª
â€» ç›®çš„: /health ã¨ /docs ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€ä»¥é™ã®æ©Ÿèƒ½è¿½åŠ ã®è¶³å ´ã«ã™ã‚‹ï¼ˆå› æžœ: ã“ã“ã§å¤±æ•—ã‚’æ½°ã™ã¨å¾Œç¶šãƒ‡ãƒãƒƒã‚°ãŒæ¥½ï¼‰ã€‚

```bash
# ä»®æƒ³ç’°å¢ƒãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
# ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã« (venv) ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšï¼‰

# ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š
- `http://localhost:8000/health` â†’ `{"status": "ok"}` ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- `http://localhost:8000/docs` â†’ Swagger UI ãŒè¡¨ç¤ºã•ã‚Œã‚‹

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] FastAPI ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚ŒãŸ
- [ ] ä»®æƒ³ç’°å¢ƒãŒä½œæˆã•ã‚Œã€æœ‰åŠ¹åŒ–ã•ã‚ŒãŸ
- [ ] å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸ
- [ ] `app/db.py` ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãŒè¨­å®šã•ã‚ŒãŸ
- [ ] `app/models.py` ã§ Post ãƒ¢ãƒ‡ãƒ«ãŒå®šç¾©ã•ã‚ŒãŸ
- [ ] `app/schemas.py` ã§ Pydantic ã‚¹ã‚­ãƒ¼ãƒžãŒå®šç¾©ã•ã‚ŒãŸ
- [ ] `app/main.py` ã§åŸºæœ¬çš„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…ã•ã‚ŒãŸ
- [ ] `/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‹•ä½œã™ã‚‹
- [ ] `/docs` ã§ Swagger UI ãŒè¡¨ç¤ºã•ã‚Œã‚‹

## ðŸŽ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®åŸºæœ¬è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€**step5.md** ã«é€²ã‚“ã§ãã ã•ã„ã€‚
ï¼ˆç”»åƒä¿å­˜ï¼šSupabase Storage ã®è¨­å®šï¼‰

