# Step 4: Backend ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆFastAPI + SQLite + SQLAlchemyï¼‰

## ðŸ“‹ ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚„ã‚‹ã“ã¨

Instagram ã‚¯ãƒ­ãƒ¼ãƒ³ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
- FastAPI ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
- SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®š
- SQLAlchemy ã®è¨­å®š
- åŸºæœ¬çš„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…

## âœ… æ‰‹é †

### 4-1) ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
â€» ç›®çš„: APIç”¨ã®ç‹¬ç«‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ‡ã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã¨ç–Žçµåˆã«ã™ã‚‹åœŸå°ã‚’ä½œã‚‹ï¼ˆå› æžœ: å¾Œã®Dockeråˆ†é›¢ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®¹æ˜“ã«ãªã‚‹ï¼‰ã€‚

```bash
# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd ~/work

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir insta-clone-api
cd insta-clone-api
```

### 4-2) ä»®æƒ³ç’°å¢ƒã®ä½œæˆï¼ˆæŽ¨å¥¨ï¼‰
â€» ç›®çš„: ä¾å­˜è¡çªã‚’é¿ã‘ã€ç’°å¢ƒã‚’å†ç¾å¯èƒ½ã«ã™ã‚‹ã€‚

```bash
# ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆ
python3 -m venv venv

# ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–
source venv/bin/activate  # macOS/Linux
# Windows ã®å ´åˆã¯: venv\Scripts\activate
```

### 4-3) ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
â€» ç›®çš„: FastAPI + SQLAlchemy ã‚’æœ€å°æ§‹æˆã§å‹•ã‹ã™åŸºç›¤ã‚’ç”¨æ„ã€‚

```bash
# FastAPI ã¨ãã®ä¾å­˜é–¢ä¿‚
pip install fastapi uvicorn[standard] python-dotenv

# SQLAlchemyï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ORMï¼‰
pip install sqlalchemy
```

### 4-4) ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã®ä½œæˆ
â€» ç›®çš„: appé…ä¸‹ã«è²¬å‹™ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã€ä¿å®ˆæ€§ã‚’ç¢ºä¿ã€‚

```bash
# app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
mkdir -p app
touch app/__init__.py
touch app/main.py
touch app/db.py
touch app/models.py
touch app/schemas.py
touch app/storage.py
```

### 4-5) ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šï¼ˆapp/db.pyï¼‰
â€» ç›®çš„: DBæŽ¥ç¶šã¨Sessionç®¡ç†ã‚’ä¸€å…ƒåŒ–ã—ã€å„APIã§å†åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

`app/db.py` ã‚’ç·¨é›†ã—ã¾ã™ï¼š

```python
from sqlalchemy import create_engine
# from sqlalchemy: SQLAlchemyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€
# create_engine: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŽ¥ç¶šã‚’ç®¡ç†ã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆã™ã‚‹é–¢æ•°

from sqlalchemy.ext.declarative import declarative_base
# declarative_base: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹é–¢æ•°

from sqlalchemy.orm import sessionmaker
# sessionmaker: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•°

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šURLï¼ˆSQLiteï¼‰
SQLALCHEMY_DATABASE_URL = "sqlite:///./app.db"
# SQLALCHEMY_DATABASE_URL: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã®URL
# "sqlite:///./app.db": SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
# sqlite:///: SQLiteã®æŽ¥ç¶šãƒ—ãƒ­ãƒˆã‚³ãƒ«
# ./app.db: ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«app.dbã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã®ä½œæˆï¼ˆSQLiteç”¨ã®è¨­å®šã‚’å«ã‚€ï¼‰
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, 
    # SQLALCHEMY_DATABASE_URL: æŽ¥ç¶šå…ˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URL
    connect_args={"check_same_thread": False}
    # connect_args: æŽ¥ç¶šæ™‚ã®è¿½åŠ å¼•æ•°
    # {"check_same_thread": False}: SQLiteç”¨ã®è¨­å®šï¼ˆãƒžãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œï¼‰
    # SQLiteã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒžãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è¨±å¯ã—ãªã„ãŒã€FastAPIã¯éžåŒæœŸã§å‹•ä½œã™ã‚‹ãŸã‚å¿…è¦
)

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ã®ä½œæˆï¼ˆå„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼‰
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
# sessionmaker: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•°
# autocommit=False: è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆæ˜Žç¤ºçš„ã«commit()ã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹ï¼‰
# autoflush=False: è‡ªå‹•ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚ã«è‡ªå‹•ä¿å­˜ã—ãªã„ï¼‰
# bind=engine: ã©ã®ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ã†ã‹ã‚’æŒ‡å®š

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹
Base = declarative_base()
# declarative_base(): ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ
# ã“ã®Baseã‚’ç¶™æ‰¿ã™ã‚‹ã“ã¨ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ãŒç°¡å˜ã«ãªã‚‹
```

### 4-6) ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼ˆapp/models.pyï¼‰
â€» ç›®çš„: postsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ ã‚’ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã—ã€ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸºç›¤ã«å‚™ãˆã‚‹ã€‚

`app/models.py` ã‚’ç·¨é›†ã—ã¾ã™ï¼š

```python
from sqlalchemy import Column, Integer, String, DateTime
# Column: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚«ãƒ©ãƒ ï¼ˆåˆ—ï¼‰ã‚’å®šç¾©ã™ã‚‹ã‚¯ãƒ©ã‚¹
# Integer: æ•´æ•°åž‹ã®ãƒ‡ãƒ¼ã‚¿åž‹
# String: æ–‡å­—åˆ—åž‹ã®ãƒ‡ãƒ¼ã‚¿åž‹
# DateTime: æ—¥æ™‚åž‹ã®ãƒ‡ãƒ¼ã‚¿åž‹

from sqlalchemy.sql import func
# func: SQLé–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆä¾‹: func.now()ã§ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ï¼‰

from app.db import Base
# Base: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹ï¼ˆapp/db.pyã§å®šç¾©ï¼‰

# æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ã™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«
class Post(Base):
    # class Post: æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹
    # (Base): Baseã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ãŒç°¡å˜ã«ãªã‚‹ï¼‰
    
    __tablename__ = "posts"
    # __tablename__: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½œæˆã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æŒ‡å®š
    # "posts": ãƒ†ãƒ¼ãƒ–ãƒ«å

    id = Column(Integer, primary_key=True, index=True)
    # Column: ã‚«ãƒ©ãƒ ã‚’å®šç¾©
    # Integer: æ•´æ•°åž‹
    # primary_key=True: ä¸»ã‚­ãƒ¼ï¼ˆä¸€æ„ã®è­˜åˆ¥å­ï¼‰ã«è¨­å®š
    # index=True: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼ˆæ¤œç´¢ãŒé«˜é€ŸåŒ–ã•ã‚Œã‚‹ï¼‰
    
    image_url = Column(String, nullable=False)
    # String: æ–‡å­—åˆ—åž‹ï¼ˆé•·ã•åˆ¶é™ãªã—ï¼‰
    # nullable=False: NULLå€¤ã‚’è¨±å¯ã—ãªã„ï¼ˆå¿…é ˆé …ç›®ï¼‰
    
    caption = Column(String, nullable=True)
    # nullable=True: NULLå€¤ã‚’è¨±å¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã€ç©ºã§ã‚‚OKï¼‰
    
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    # DateTime(timezone=True): ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’å«ã‚€æ—¥æ™‚åž‹
    # server_default=func.now(): ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§è‡ªå‹•çš„ã«ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š
    # func.now(): SQLã®NOW()é–¢æ•°ã‚’å®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ï¼‰
```

### 4-7) ã‚¹ã‚­ãƒ¼ãƒžå®šç¾©ï¼ˆapp/schemas.pyï¼‰
â€» ç›®çš„: å…¥å‡ºåŠ›ã®åž‹ã‚’æ˜Žç¤ºã—ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨è‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã‚’è¡Œã†ã€‚

`app/schemas.py` ã‚’ç·¨é›†ã—ã¾ã™ï¼š

```python
from pydantic import BaseModel
# BaseModel: Pydanticã®åŸºåº•ã‚¯ãƒ©ã‚¹ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
# FastAPIã¯Pydanticã‚’ä½¿ã£ã¦ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®åž‹ãƒã‚§ãƒƒã‚¯ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†

from datetime import datetime
# datetime: æ—¥æ™‚ã‚’æ‰±ã†ãŸã‚ã®ã‚¯ãƒ©ã‚¹

# æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬ã‚¹ã‚­ãƒ¼ãƒžï¼ˆå…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
class PostBase(BaseModel):
    # class PostBase: æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬ã‚¹ã‚­ãƒ¼ãƒžï¼ˆå…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®šç¾©ï¼‰
    # (BaseModel): Pydanticã®BaseModelã‚’ç¶™æ‰¿
    
    image_url: str
    # image_url: ç”»åƒURLï¼ˆæ–‡å­—åˆ—åž‹ã€å¿…é ˆé …ç›®ï¼‰
    # str: æ–‡å­—åˆ—åž‹
    
    caption: str | None = None
    # caption: ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ–‡å­—åˆ—åž‹ã¾ãŸã¯Noneã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    # str | None: Python 3.10+ã®è¨˜æ³•ã§ã€strã¾ãŸã¯Noneã‚’æ„å‘³
    # = None: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’Noneã«è¨­å®šï¼ˆæŒ‡å®šã—ãªãã¦ã‚‚OKï¼‰

# æ–°è¦æŠ•ç¨¿ä½œæˆæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚­ãƒ¼ãƒž
class PostCreate(PostBase):
    # class PostCreate: æ–°è¦æŠ•ç¨¿ä½œæˆæ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚­ãƒ¼ãƒž
    # (PostBase): PostBaseã‚’ç¶™æ‰¿ï¼ˆimage_urlã¨captionã‚’å«ã‚€ï¼‰
    pass
    # pass: ä½•ã‚‚è¿½åŠ ã—ãªã„ï¼ˆPostBaseã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
    # idã‚„created_atã¯å«ã¾ãªã„ï¼ˆã“ã‚Œã‚‰ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ï¼‰

# æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒžï¼ˆå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€ï¼‰
class Post(PostBase):
    # class Post: æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒžï¼ˆå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€ï¼‰
    # (PostBase): PostBaseã‚’ç¶™æ‰¿
    
    id: int
    # id: æŠ•ç¨¿IDï¼ˆæ•´æ•°åž‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§è‡ªå‹•ç”Ÿæˆï¼‰
    
    created_at: datetime
    # created_at: ä½œæˆæ—¥æ™‚ï¼ˆdatetimeåž‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§è‡ªå‹•è¨­å®šï¼‰

    class Config:
        # class Config: Pydanticã®è¨­å®šã‚¯ãƒ©ã‚¹
        from_attributes = True
        # from_attributes = True: SQLAlchemyãƒ¢ãƒ‡ãƒ«ã‹ã‚‰è‡ªå‹•çš„ã«Pydanticãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›å¯èƒ½
        # ã“ã‚Œã«ã‚ˆã‚Šã€db.query(Post).all()ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã€ãã®ã¾ã¾Postã‚¹ã‚­ãƒ¼ãƒžã¨ã—ã¦è¿”ã›ã‚‹
```

### 4-8) ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆapp/main.pyï¼‰
â€» ç›®çš„: CORSã‚„ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å«ã‚€æœ€å°APIã‚’æ§‹ç¯‰ã—ã€å‹•ä½œç¢ºèªã®åŸºæº–ç‚¹ã‚’ä½œã‚‹ã€‚

`app/main.py` ã‚’ç·¨é›†ã—ã¾ã™ï¼š

```python
from fastapi import FastAPI, Depends, HTTPException
# FastAPI: FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒ©ã‚¹
# Depends: ä¾å­˜æ€§æ³¨å…¥ï¼ˆå„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§DBã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã©ã‚’å–å¾—ï¼‰
# HTTPException: HTTPã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ãŸã‚ã®ä¾‹å¤–ã‚¯ãƒ©ã‚¹

from fastapi.middleware.cors import CORSMiddleware
# CORSMiddleware: CORSï¼ˆCross-Origin Resource Sharingï¼‰è¨­å®šç”¨ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
# ç•°ãªã‚‹ã‚ªãƒªã‚¸ãƒ³ï¼ˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒãƒ¼ãƒˆï¼‰é–“ã§ã®é€šä¿¡ã‚’è¨±å¯

from sqlalchemy.orm import Session
# Session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åž‹

from typing import List
# List: ãƒªã‚¹ãƒˆï¼ˆé…åˆ—ï¼‰ã®åž‹ãƒ’ãƒ³ãƒˆ

import os
# os: ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®æ©Ÿèƒ½ï¼ˆç’°å¢ƒå¤‰æ•°ã®å–å¾—ãªã©ï¼‰

from dotenv import load_dotenv
# load_dotenv: .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°

from app import models, schemas
# models: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼ˆapp/models.pyï¼‰
# schemas: Pydanticã‚¹ã‚­ãƒ¼ãƒžï¼ˆapp/schemas.pyï¼‰

from app.db import SessionLocal, engine
# SessionLocal: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼
# engine: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()
# load_dotenv(): .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
# ã“ã‚Œã«ã‚ˆã‚Šã€os.getenv()ã§ç’°å¢ƒå¤‰æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®è‡ªå‹•ä½œæˆ
models.Base.metadata.create_all(bind=engine)
# models.Base.metadata: ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æƒ…å ±ï¼‰
# create_all(): ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è‡ªå‹•ä½œæˆ
# bind=engine: ã©ã®ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ã†ã‹ã‚’æŒ‡å®š

# FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
app = FastAPI()
# FastAPI(): FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
# app: APIã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã„ãï¼‰

# CORSè¨­å®šï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ï¼‰
allowed_origins = os.getenv("ALLOWED_ORIGINS", "http://localhost:3000").split(",")
# os.getenv(): ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—
# "ALLOWED_ORIGINS": ç’°å¢ƒå¤‰æ•°ã®ã‚­ãƒ¼
# "http://localhost:3000": ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆç’°å¢ƒå¤‰æ•°ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼‰
# .split(","): ã‚«ãƒ³ãƒžã§åˆ†å‰²ã—ã¦ãƒªã‚¹ãƒˆã«å¤‰æ›ï¼ˆè¤‡æ•°ã®ã‚ªãƒªã‚¸ãƒ³ã‚’æŒ‡å®šå¯èƒ½ï¼‰

app.add_middleware(
    # add_middleware(): ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’è¿½åŠ ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ã™ã‚‹å‰å¾Œã«å®Ÿè¡Œï¼‰
    CORSMiddleware,
    # CORSMiddleware: CORSè¨­å®šç”¨ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
    allow_origins=allowed_origins,
    # allow_origins: è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã®ãƒªã‚¹ãƒˆ
    allow_credentials=True,
    # allow_credentials: ã‚¯ãƒƒã‚­ãƒ¼ãªã©ã®èªè¨¼æƒ…å ±ã‚’è¨±å¯
    allow_methods=["*"],
    # allow_methods: è¨±å¯ã™ã‚‹HTTPãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ["*"]ã¯ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¨±å¯ï¼‰
    allow_headers=["*"],
    # allow_headers: è¨±å¯ã™ã‚‹HTTPãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ["*"]ã¯ã™ã¹ã¦ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨±å¯ï¼‰
)

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¾å­˜é–¢ä¿‚ï¼ˆå„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ï¼‰
def get_db():
    # get_db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆä¾å­˜æ€§æ³¨å…¥ã§ä½¿ç”¨ï¼‰
    db = SessionLocal()
    # SessionLocal(): æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    try:
        # try: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å‡¦ç†ã‚’å›²ã‚€
        yield db
        # yield: ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿é–¢æ•°ï¼ˆå€¤ã‚’è¿”ã—ã¦å‡¦ç†ã‚’ä¸€æ™‚åœæ­¢ï¼‰
        # db: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã—å…ƒï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰ã«æ¸¡ã™
    finally:
        # finally: æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå¿…ãšå®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†
        db.close()
        # db.close(): ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ãï¼‰

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
@app.get("/health")
# @app.get: GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®šç¾©ï¼ˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ï¼‰
# "/health": ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ‘ã‚¹

def health_check():
    # health_check: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ã®é–¢æ•°
    return {"status": "ok"}
    # return: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
    # {"status": "ok"}: è¾žæ›¸å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆFastAPIãŒè‡ªå‹•çš„ã«JSONã«å¤‰æ›ï¼‰

# æŠ•ç¨¿ä¸€è¦§å–å¾—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
@app.get("/posts", response_model=List[schemas.Post])
# "/posts": ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ‘ã‚¹
# response_model: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®åž‹ã‚’æŒ‡å®šï¼ˆè‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«ä½¿ç”¨ï¼‰
# List[schemas.Post]: æŠ•ç¨¿ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™

def get_posts(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    # get_posts: æŠ•ç¨¿ä¸€è¦§ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    # skip: int = 0: ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯0ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
    # limit: int = 100: å–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯100ï¼‰
    # db: Session = Depends(get_db): ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆä¾å­˜æ€§æ³¨å…¥ï¼‰
    # Depends(get_db): get_dbé–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æŠ•ç¨¿ã‚’å–å¾—ï¼ˆä½œæˆæ—¥æ™‚ã®é™é †ã§ã‚½ãƒ¼ãƒˆï¼‰
    posts = db.query(models.Post).order_by(models.Post.created_at.desc()).offset(skip).limit(limit).all()
    # db.query(models.Post): Postãƒ¢ãƒ‡ãƒ«ã‚’ã‚¯ã‚¨ãƒªï¼ˆSQLã®SELECTæ–‡ã‚’ç”Ÿæˆï¼‰
    # .order_by(): ã‚½ãƒ¼ãƒˆé †ã‚’æŒ‡å®š
    # models.Post.created_at.desc(): ä½œæˆæ—¥æ™‚ã®é™é †ï¼ˆæ–°ã—ã„é †ï¼‰
    # .offset(skip): ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ä»¶æ•°ï¼ˆSQLã®OFFSETå¥ï¼‰
    # .limit(limit): å–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°ï¼ˆSQLã®LIMITå¥ï¼‰
    # .all(): ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦çµæžœã‚’ãƒªã‚¹ãƒˆã¨ã—ã¦å–å¾—
    
    return posts
    # return: å–å¾—ã—ãŸæŠ•ç¨¿ãƒªã‚¹ãƒˆã‚’è¿”ã™ï¼ˆFastAPIãŒè‡ªå‹•çš„ã«JSONã«å¤‰æ›ï¼‰

# æŠ•ç¨¿ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯Step 5ã§å®Ÿè£…ï¼‰
@app.post("/posts", response_model=schemas.Post)
# @app.post: POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®šç¾©
# response_model=schemas.Post: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®åž‹ã‚’æŒ‡å®š

def create_post(post: schemas.PostCreate, db: Session = Depends(get_db)):
    # create_post: æ–°è¦æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹é–¢æ•°
    # post: schemas.PostCreate: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆFastAPIãŒè‡ªå‹•çš„ã«Pydanticãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›ï¼‰
    
    # Pydanticãƒ¢ãƒ‡ãƒ«ã‹ã‚‰SQLAlchemyãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›
    db_post = models.Post(**post.dict())
    # post.dict(): Pydanticãƒ¢ãƒ‡ãƒ«ã‚’è¾žæ›¸ã«å¤‰æ›
    # **post.dict(): è¾žæ›¸ã‚’å±•é–‹ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•æ•°ã¨ã—ã¦æ¸¡ã™
    # models.Post(): Postãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
    db.add(db_post)
    # db.add(): ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ ï¼ˆã¾ã ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ä¿å­˜ã•ã‚Œã¦ã„ãªã„ï¼‰
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚³ãƒŸãƒƒãƒˆ
    db.commit()
    # db.commit(): å¤‰æ›´ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ°¸ç¶šåŒ–ï¼ˆSQLã‚’å®Ÿè¡Œï¼‰
    
    # ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆè‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸidã‚„created_atã‚’å–å¾—ï¼‰
    db.refresh(db_post)
    # db.refresh(): ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆidã‚„created_atãŒè¨­å®šã•ã‚Œã‚‹ï¼‰
    
    return db_post
    # return: ä½œæˆã•ã‚ŒãŸæŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ï¼ˆFastAPIãŒè‡ªå‹•çš„ã«JSONã«å¤‰æ›ï¼‰
```

### 4-9) ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.envï¼‰
â€» ç›®çš„: ç’°å¢ƒä¾å­˜å€¤ã‚’ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ†é›¢ã—ã€æœ¬ç•ª/é–‹ç™ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚„ã™ãã™ã‚‹ã€‚

`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ï¼š

```bash
cat > .env << 'EOF'
ALLOWED_ORIGINS=http://localhost:3000
EOF
```

### 4-10) ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã¨å‹•ä½œç¢ºèª
â€» ç›®çš„: /health ã¨ /docs ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€ä»¥é™ã®æ©Ÿèƒ½è¿½åŠ ã®è¶³å ´ã«ã™ã‚‹ï¼ˆå› æžœ: ã“ã“ã§å¤±æ•—ã‚’æ½°ã™ã¨å¾Œç¶šãƒ‡ãƒãƒƒã‚°ãŒæ¥½ï¼‰ã€‚

```bash
# ä»®æƒ³ç’°å¢ƒãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
# ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã« (venv) ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšï¼‰

# ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š
- `http://localhost:8000/health` â†’ `{"status": "ok"}` ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- `http://localhost:8000/docs` â†’ Swagger UI ãŒè¡¨ç¤ºã•ã‚Œã‚‹

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] FastAPI ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚ŒãŸ
- [ ] ä»®æƒ³ç’°å¢ƒãŒä½œæˆã•ã‚Œã€æœ‰åŠ¹åŒ–ã•ã‚ŒãŸ
- [ ] å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸ
- [ ] `app/db.py` ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šãŒè¨­å®šã•ã‚ŒãŸ
- [ ] `app/models.py` ã§ Post ãƒ¢ãƒ‡ãƒ«ãŒå®šç¾©ã•ã‚ŒãŸ
- [ ] `app/schemas.py` ã§ Pydantic ã‚¹ã‚­ãƒ¼ãƒžãŒå®šç¾©ã•ã‚ŒãŸ
- [ ] `app/main.py` ã§åŸºæœ¬çš„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…ã•ã‚ŒãŸ
- [ ] `/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‹•ä½œã™ã‚‹
- [ ] `/docs` ã§ Swagger UI ãŒè¡¨ç¤ºã•ã‚Œã‚‹

## ðŸŽ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®åŸºæœ¬è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€**step5.md** ã«é€²ã‚“ã§ãã ã•ã„ã€‚
ï¼ˆç”»åƒä¿å­˜ï¼šSupabase Storage ã®è¨­å®šï¼‰

